/* 351-DPAN  -  PERFORM DYNAMIC PANNING FUNCTION OR AMPLITUDE MODULATION   Modified:   02/07/91 - MWH - Combine 3200, 6400 and 9600 RTP's   04/05/90 - TSS - FIX STUCK MIDI NOTE/EXTRA NOTE OFF BUGS   05/15/86 - "official" creation of release-M modules*/IF (NOT MONO_VOICES_PRESENT) THEN BEGIN;  /* ONLY DO DPAN STUFF FOR STEREO VOICES */  WRITE(MAM)=TBP;  WRITE(MAL)=TIM.ANY.DPAN;  IF READ(MD)<>0 THEN DO;         /* IF DYNAMIC PANNING   */    PPTR=PTLST;                   /* GET POINTER TO PARTIAL LIST */    DO WHILE PPTR<>0;             /* LOOP OVER PARTIALS */      IF PANR<>0 THEN DO;         /* MUST PERFORM PAN UPDATE */        IF PSTAT THEN DO;  /* DO ONLY IF ACTIVE (SKIP OVER SEQUENCER NOTES QUED BUT NOT STARTED) (BUT BLOWS UP ON REPEATED NOTES WITH LONG DELAYS) */          LOAD SAMPLED.REAL.MILLISECONDS-PRIOR.REAL.MILLISECONDS;           MUL  (PANR&255);       /* RATE * MILLISECONDS.SINCE.LAST.COMPUTATION */          I=PANA+RES;            /* GET PAN ACCUMULATOR HANDY, ADD INCREMENT */          IF I>=10000 THEN I=I-10000; /* MODULO 10000 */          PANA=I;                 /* STORE FOR NEXT COMPUTATION */          WRITE(MAM)=TBP;          WRITE(MAL)=TIM.PAN.PHASE+PARTL;          WRITE(MD )=I;           /* SAVE IN ARRAY FOR SYNCHRONOUS FUNCTIONS */          J=SHR(PANF,9);          /* LOOK UP ST/AM MODE  */          K=PANF&511;             /* GET ST CENTER 0-256 */          L=SHR(PANR,8);          /* GET ST DEPTH (0-128 FOR STEREO, 0-50 FOR A.M.) */          IF J>20 THEN DO;              /* AMPLITUDE MODULATION */            IF J>22 THEN I=I+7500;      /* PHASE OFFSET FOR DECAY */            ELSE         I=I+2500;      /* PHASE OFFSET FOR ATTACK */            IF I>=10000 THEN I=I-10000; /* MODULO */            WRITE(5)=I; WRITE(6)=256; M=READ(5); WRITE(7)=10000; /* MAP 0-9999 TO 0-255 */            WRITE(MAM)=STB.PTR+SHR(RES,8); WRITE(MAL)=RES;            M=READ(MD);       /* LOOK UP INFO FROM SINE TABLE */            K=RVOL;           /* LOOK UP RTE VOLUME */            WRITE(5)=K; WRITE(6)=M; M=READ(5); WRITE(7)=2047; /* SCALE VOLUME BY SINE FUNCTION */            WRITE(5)=READ(5); WRITE(6)=L; M=READ(5); WRITE(7)=50; /* SCALE BY DEPTH (ALLOW FULL MODULATION NOW) */            AVOL=SHL(K-RES,8);     /* STORE IN UPPER HALF FOR FRACTIONAL MULTIPLY */          END;           /* $PAGE - PERFORM DYNAMIC PAN */          ELSE DO;                 /* PERFORM STEREO UPDATE */            IF J>=13 THEN J=J-6;   /* MAP SYNC & NON SYNC FUNCTIONS TOGETHER HERE */            DO CASE SHR(J-7,1);    /* BRANCH FOR COMPUTATION TYPE */              ; /* 7,8,13,14 = DELETED MODE */              DO; /* 9,10,15,16 = SINE (ACTUALLY USE TRIANGLE) */                I=I+2500; /* CORRECT FOR PHASE ERROR */                IF I>=10000 THEN I=I-10000;                IF I>=5000  THEN I=10000-I; /* 0-4999, THEN 5000 DOWN TO 1 */                I=SHL(I,1); /* PRODUCES 0-10000 TRIANGLE */                WRITE(5)=I; WRITE(6)=L; M=READ(5); WRITE(7)=5000; /* MAP 0-10000 TO 0-(2*DEPTH) */                M=READ(5)-L; /* COMPUTE -DEPTH TO +DEPTH TRIANGLE FUNCTION */              END;              DO; /* 11,12,17,18 = SQUARE WAVE FUNCTION */                M=L; /* GET DEPTH */                IF I<5000 THEN M=-M; /* CHANGE SIGN */              END;            END;                                   /* OF DO CASE */            IF NOT(J) THEN M=-M;                   /* REVERSE FUNCTION */            K=K+M;                                 /* ADD TO CENTER */            IF K<0 THEN K=0; IF K>256 THEN K=256;  /* APPLY LIMITS */            IF  ((INC.MONO=0)                      /* IF NO SAMPLING AT ALL */            AND  (INC.POLY=0))            OR (MCHN&(B.MONO\B.POLY))=0 THEN DO;   /* OR ORIGINAL SYNTHESIZER - COMPUTE ITEMS */               IF K=256 THEN K=255;                /* LIMIT TO FM HARDWARE MAX */               WRITE(MAM)=TBP;               WRITE(MAL)=TIM.I.ISHC+PARTL;               K=(K&"374")+READ(MD);               /* OR IN ISHC */               FMINFO=(FMINFO&"177400")\K;         /* MOSTLY IN CASE OF REPEAT/ARPEGGIATE */               DISABLE;               WRITE(CHA)=MCHN; WRITE(FUN)=ISHC; WRITE(DAT)=K; /* WRITE OUT STEREO INFO */               IF (SMCHN<>0) THEN DO;             /* UPDATE SPLICE CHANNEL TOO */                  WRITE(CHA)=SMCHN; WRITE(DAT)=K; /* WRITE OUT STEREO INFO */               END;               ENABLE;            END;       /* OF BEGIN FOR ORIGINAL SYNTHESIZER */            ELSE IF (INC.MONO<>0)&((MCHN&B.MONO)<>0) THEN DO;  /* MONO SAMPLING (W. DISK) */               /* DYNAMIC PANNING NOT POSSIBLE WITH MONO SYNTH */            END;            ELSE IF (INC.POLY<>0) THEN DO;                  /* MEANS POLY SYNTH */               IDAT=K;                                      /* SAVE STEREO INFO FOR VOLUME WRITES */            END;          END;                    /* OF PERFORM STEREO UPDATE */        END;                      /* OF DO FOR ACTIVE STATE */      END;          /* OF MUST PERFORM PAN UPDATE */      PPTR=PFPTR;   /* MOVE ON TO NEXT PARTIAL */    END;            /* OF PARTIAL LOOP */  END;              /* OF BEGIN FOR ANY DYNAMIC PANNING */END;                /* OF BEGIN */