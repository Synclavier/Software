/* $subtitle Definitions for External Memory */dcl mam  lit '"60"';     /* memory address msb */dcl mal  lit '"61"';     /* memory address lsb */dcl md   lit '"62"';     /* memory data */dcl mdi  lit '"63"';     /* memory data with increment */dcl examount fixed;COPY.IN:PROC(DES,LEN);                  /* COPY BLOCK INTO MAIN MEMORY - SET UP MAM & MAL BEFORE CALLING */   DCL (DES,LEN) FIXED;   WRITE("313")=DES;                    /* SET UP CORE POINTER */   DO WHILE LEN IGE 16;                 /* COPY 16 WORD CHUNKS */      WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI);      WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI);      WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI);      WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI); WRITE("373")=READ(MDI);      LEN=LEN-16;   END;   DO WHILE LEN<>0; WRITE("373")=READ(MDI); LEN=LEN-1; END; /* FINISH OUT PARTIAL SECTOR */END COPY.IN;COPY.OUT:PROC(SOU,LEN);                 /* COPY BLOCK TO EX MEM - SET UP MAM & MAL BEFORE CALLING */   DCL (SOU,LEN) FIXED;   WRITE("313")=SOU;                    /* SET UP CORE POINTER */   DO WHILE LEN IGE 16;                 /* COPY 16 WORD CHUNKS */      WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373");      WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373");      WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373");      WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373"); WRITE(MDI)=READ("373");      LEN=LEN-16;   END;   DO WHILE LEN<>0; WRITE(MDI)=READ("373"); LEN=LEN-1; END; /* FINISH OUT PARTIAL SECTOR */END COPY.OUT;COPY.EXT.MEM:PROC(SOUM,SOUL,DESM,DESL,LEN);  /* HIGH SPEED COPIES - COPIES UP OR DOWN, ANY LENGTH, IN EXTERNAL MEMORY */   DCL (I,SOUM,SOUL,DESM,DESL,LEN) FIXED;   DCL CBUF(256) FIXED;   SOUM=SOUM+SHR(SOUL,8); SOUL=SOUL&255;     /* CONVERT FROM BASE+ OFFSET TO SECTOR + WORD */   DESM=DESM+SHR(DESL,8); DESL=DESL&255;     /* CONVERT FROM BASE+ OFFSET TO SECTOR + WORD */   IF (SOUM=DESM)&(SOUL=DESL) THEN RETURN;   /* CHECK HERE FOR EQUAL - NO NEED TO MOVE */   IF (SOUM IGT DESM)\((SOUM=DESM)&(SOUL IGT DESL)) THEN DO; /* COPY DOWN */      DO WHILE LEN<>0;                       /* PROCESS DESIRED WORDS */         I=256;                              /* GET COPY BUFFER LENGTH IN WORDS */         IF I IGT LEN THEN I=LEN;         WRITE(MAM)=SOUM; WRITE(MAL)=SOUL;         CALL COPY.IN(ADDR(CBUF(0)),I);      /* GET DATA FROM EX MEM */         SOUM=READ(MAM);  SOUL=READ(MAL);    /* GET CONTINUATION ADDRESS */         WRITE(MAM)=DESM; WRITE(MAL)=DESL;   /* SET UP DESTINATION */         CALL COPY.OUT(ADDR(CBUF(0)),I);     /* WRITE DATA OUT */         DESM=READ(MAM);  DESL=READ(MAL);    /* GET CONTINUATION ADDRESS */         LEN=LEN-I;                          /* ACCOUNT FOR WORDS COPIED */      END;   END;   ELSE DO; /* COPY UP - MUST START AT TOP AND WORK DOWN */      SOUL=SOUL+LEN; DESL=DESL+LEN; /* COMPUTE TOP POINTERS */      SOUM=SOUM+SHR(SOUL,8); SOUL=SOUL&255;      DESM=DESM+SHR(DESL,8); DESL=DESL&255;      DO WHILE LEN<>0;                          /* PROCESS DESIRED WORDS */         I=256;                                 /* GET COPY BUFFER LENGTH IN WORDS */         IF I IGT LEN THEN I=LEN;         SOUL=SOUL-I;                           /* BACK UP POINTER BY LENGTH TO COPY */         IF SOUL<0 THEN DO;                     /* BACK UP MSB AS WELL */            SOUM=SOUM+("177400"\SHR(SOUL,8));   /* CONSTRUCT - NUMBER, ADD IN */            SOUL=SOUL&255;                      /* GET POSITIVE MSB */         END;         WRITE(MAM)=SOUM; WRITE(MAL)=SOUL;         CALL COPY.IN(ADDR(CBUF(0)),I);         /* GET DATA FROM EX MEM */         DESL=DESL-I;                           /* BACK UP POINTER BY LENGTH TO COPY */         IF DESL<0 THEN DO;                     /* BACK UP MSB AS WELL */            DESM=DESM+("177400"\SHR(DESL,8));   /* CONSTRUCT - NUMBER, ADD IN */            DESL=DESL&255;                      /* GET POSITIVE MSB */         END;         WRITE(MAM)=DESM; WRITE(MAL)=DESL;      /* SET UP DESTINATION */         CALL COPY.OUT(ADDR(CBUF(0)),I);        /* WRITE DATA OUT */         LEN=LEN-I;                             /* ACCOUNT FOR WORDS COPIED */      END;   END;END COPY.EXT.MEM;COPY.EXT.MEM.SEC:PROC(SOU,DES,LEN);   DCL SOU FIXED;   DCL LEN FIXED;   DCL DES FIXED;   CALL COPY.EXT.MEM(SOU,0,DES,0,SHL(LEN,8));END COPY.EXT.MEM.SEC;EXT.READDATA:PROC(MSB,LSB,BUFP,BUFL,XSEC,LEN);  /* READ DATA FROM DISK INTO EXTERNAL MEMORY */   DCL (MSB,LSB,BUFP,BUFL,XSEC,LEN,I,J) FIXED;  /* NOTE - LENGTH IN SECTORS (FINALLY!!!) */   WRITE(MAM)=XSEC;                        /* SET UP EX MEMORY ADDRESS */   BUFL=SHR(BUFL,8);                       /* GET BUFFER LENGTH IN SECTORS */   DO WHILE LEN<>0;                        /* PROCESS EACH SECTOR FOR NOW */      I=BUFL;                              /* GET DISK BUFFER LENGTH IN SECTORS */      IF I IGT LEN THEN I=LEN;      CALL READDATA(MSB,LSB,LOCATION(BUFP),SHL(I,8));       CALL COPY.OUT(BUFP,SHL(I,8));        /* WRITE OUT TO EXT MEMORY */      LEN=LEN-I;                           /* ACCOUNT FOR WORDS COPIED ABOVE */      LSB=LSB+I; IF LSB ILT I THEN MSB=MSB+1;   END;END EXT.READDATA;EXT.WRITEDATA:PROC(MSB,LSB,BUFP,BUFL,XSEC,LEN);  /* WRITE DATA TO DISK FROM EXTERNAL MEMORY */   DCL (MSB,LSB,BUFP,BUFL,XSEC,LEN,I,J) FIXED;  /* NOTE - LENGTH IN SECTORS (FINALLY!!!) */   WRITE(MAM)=XSEC;                        /* SET UP EX MEMORY ADDRESS */   BUFL=SHR(BUFL,8);                       /* GET BUFFER LENGTH IN SECTORS */   DO WHILE LEN<>0;                        /* PROCESS EACH SECTOR FOR NOW */      I=BUFL;                              /* GET DISK BUFFER LENGTH IN SECTORS */      IF I IGT LEN THEN I=LEN;      CALL COPY.IN(BUFP,SHL(I,8));         /* GET DATA IN MAIN MEMORY */      CALL WRITEDATA(MSB,LSB,LOCATION(BUFP),SHL(I,8));  /* WRITE TO DISK */      LEN=LEN-I;                           /* ACCOUNT FOR WORDS COPIED ABOVE */      LSB=LSB+I; IF LSB ILT I THEN MSB=MSB+1;   END;END EXT.WRITEDATA;